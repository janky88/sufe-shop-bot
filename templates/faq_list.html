<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQç®¡ç† - å•†åŸæœºå™¨äººç®¡ç†ä¸­å¿ƒ</title>
    
    <!-- Modern Theme System -->
    <link rel="stylesheet" href="/static/css/modern-theme.css?v=1">
    <link rel="stylesheet" href="/static/css/modern-components.css?v=1">
    <link rel="stylesheet" href="/static/css/modern-layout.css?v=1">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Page Styles -->
    <style>
        :root {
            --primary-color-alpha: rgba(79, 70, 229, 0.1);
        }

        [data-theme="dark"] {
            --primary-color-alpha: rgba(99, 102, 241, 0.2);
        }

        .faq-list {
            display: grid;
            gap: var(--spacing-md);
        }
        
        .faq-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: var(--transition-default);
            cursor: move;
        }
        
        .faq-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .faq-item.dragging {
            opacity: 0.5;
        }
        
        .faq-item.inactive {
            opacity: 0.6;
            border-style: dashed;
        }
        
        .faq-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }
        
        .faq-question {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            margin-right: var(--spacing-md);
        }
        
        .faq-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .sort-handle {
            cursor: grab;
            color: var(--text-secondary);
            font-size: 1.25rem;
            padding: 0 var(--spacing-sm);
            user-select: none;
        }
        
        .sort-handle:active {
            cursor: grabbing;
        }
        
        .faq-answer {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
        }
        
        .faq-meta {
            display: flex;
            gap: var(--spacing-lg);
            font-size: 0.875rem;
            color: var(--text-tertiary);
        }
        
        .faq-meta span {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-lg);
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            margin: var(--spacing-xl) 0;
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }
        
        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .empty-text {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
        }
        
        .lang-selector {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal-content {
            position: relative;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 0;
            animation: modalSlideIn 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: var(--transition-default);
        }
        
        .modal-close:hover {
            background: var(--bg-secondary);
        }
        
        .modal-body {
            padding: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition-default);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-color-alpha);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
            background: var(--bg-secondary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    å•†åŸæœºå™¨äººç®¡ç†ä¸­å¿ƒ
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-sun sun-icon theme-toggle-icon"></i>
                        <i class="fas fa-moon moon-icon theme-toggle-icon"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <a href="/admin/">
                        <i class="fas fa-tachometer-alt nav-icon"></i>
                        ä»ªè¡¨ç›˜
                    </a>
                    <a href="/admin/products">
                        <i class="fas fa-box nav-icon"></i>
                        å•†å“ç®¡ç†
                    </a>
                    <a href="/admin/orders">
                        <i class="fas fa-shopping-cart nav-icon"></i>
                        è®¢å•ç®¡ç†
                    </a>
                    <a href="/admin/users">
                        <i class="fas fa-users nav-icon"></i>
                        ç”¨æˆ·ç®¡ç†
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">è¿è¥å·¥å…·</div>
                    <a href="/admin/recharge-cards">
                        <i class="fas fa-credit-card nav-icon"></i>
                        å……å€¼å¡ç®¡ç†
                    </a>
                    <a href="/admin/broadcast">
                        <i class="fas fa-bullhorn nav-icon"></i>
                        æ¶ˆæ¯æ¨é€
                    </a>
                    <a href="/admin/faq" class="active">
                        <i class="fas fa-question-circle nav-icon"></i>
                        FAQç®¡ç†
                    </a>
                    <a href="/admin/templates">
                        <i class="fas fa-file-alt nav-icon"></i>
                        æ¶ˆæ¯æ¨¡æ¿
                    </a>
                    <a href="/admin/tickets">
                        <i class="fas fa-ticket-alt nav-icon"></i>
                        å·¥å•ç®¡ç†
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">ç³»ç»Ÿ</div>
                    <a href="/admin/settings">
                        <i class="fas fa-cog nav-icon"></i>
                        ç³»ç»Ÿè®¾ç½®
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">å¸¸è§é—®é¢˜ç®¡ç†</h1>
                    <p class="page-subtitle">ç®¡ç†å¸¸è§é—®é¢˜å’Œè§£ç­”</p>
                    
                    <div class="page-actions">
                        <select class="lang-selector" onchange="changeLanguage(this.value)">
                            <option value="zh" {{if eq .language "zh"}}selected{{end}}>ä¸­æ–‡</option>
                            <option value="en" {{if eq .language "en"}}selected{{end}}>English</option>
                        </select>
                        <button class="btn btn-primary" onclick="showAddModal()">
                            <i class="fas fa-plus"></i> æ·»åŠ é—®é¢˜
                        </button>
                    </div>
                </div>

            <!-- FAQ List -->
            <div class="faq-list" id="faqList">
                {{if .faqs}}
                    {{range .faqs}}
                    <div class="faq-item {{if not .IsActive}}inactive{{end}}" data-id="{{.ID}}" draggable="true">
                        <div class="faq-header">
                            <div class="faq-question">{{.Question}}</div>
                            <div class="faq-actions">
                                <span class="sort-handle" title="æ‹–åŠ¨æ’åº">â‹®â‹®</span>
                                <button class="btn btn-sm btn-secondary" onclick="editFAQ({{.ID}})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteFAQ({{.ID}})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="faq-answer">{{.Answer}}</div>
                        <div class="faq-meta">
                            <span><i class="fas fa-sort"></i> æ’åº: {{.SortOrder}}</span>
                            <span><i class="fas fa-{{if .IsActive}}check{{else}}times{{end}}-circle"></i> çŠ¶æ€: {{if .IsActive}}å¯ç”¨{{else}}ç¦ç”¨{{end}}</span>
                            <span><i class="fas fa-clock"></i> æ›´æ–°: {{.UpdatedAt.Format "2006-01-02 15:04"}}</span>
                        </div>
                    </div>
                    {{end}}
                {{else}}
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¬</div>
                        <h3 class="empty-title">æš‚æ— å¸¸è§é—®é¢˜</h3>
                        <p class="empty-text">ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ é—®é¢˜"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªå¸¸è§é—®é¢˜</p>
                        <button class="btn btn-success" onclick="initializeFAQs()">
                            <i class="fas fa-magic"></i> åˆå§‹åŒ–ç¤ºä¾‹FAQ
                        </button>
                    </div>
                {{end}}
            </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="faqModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">æ·»åŠ å¸¸è§é—®é¢˜</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="faqForm" onsubmit="saveFAQ(event)">
                <div class="modal-body">
                    <input type="hidden" id="faqId" value="">
                    
                    <div class="form-group">
                        <label class="form-label">é—®é¢˜</label>
                        <input type="text" name="question" id="question" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç­”æ¡ˆ</label>
                        <textarea name="answer" id="answer" class="form-control" rows="5" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">è¯­è¨€</label>
                            <select name="language" id="language" class="form-control" required>
                                <option value="zh">ä¸­æ–‡</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">æ’åºé¡ºåº</label>
                            <input type="number" name="sort_order" id="sort_order" class="form-control" value="0" min="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="is_active" id="is_active" checked>
                            <span>å¯ç”¨æ­¤é—®é¢˜</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Scripts -->
    <script>
        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        });
        
        const currentLanguage = '{{.language}}';
        let faqs = {{.faqs}};
        
        // Logout function
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                fetch('/api/logout', { method: 'POST' })
                    .then(() => window.location.href = '/')
                    .catch(err => console.error('Logout failed:', err));
            }
        }
        
        // Change language
        function changeLanguage(lang) {
            window.location.href = '/admin/faq?lang=' + lang;
        }
        
        // Initialize FAQs
        function initializeFAQs() {
            if (!confirm('ç¡®å®šè¦åˆå§‹åŒ–ç¤ºä¾‹FAQå—ï¼Ÿ')) {
                return;
            }
            
            fetch('/admin/faq/init', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('åˆå§‹åŒ–å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            });
        }
        
        // Show add modal
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ å¸¸è§é—®é¢˜';
            document.getElementById('faqForm').reset();
            document.getElementById('faqId').value = '';
            document.getElementById('language').value = currentLanguage;
            document.getElementById('is_active').checked = true;
            document.getElementById('faqModal').classList.add('show');
        }

        // Edit FAQ
        function editFAQ(id) {
            const faq = faqs.find(f => f.ID === id);
            if (!faq) return;

            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å¸¸è§é—®é¢˜';
            document.getElementById('faqId').value = faq.ID;
            document.getElementById('question').value = faq.Question;
            document.getElementById('answer').value = faq.Answer;
            document.getElementById('language').value = faq.Language;
            document.getElementById('sort_order').value = faq.SortOrder;
            document.getElementById('is_active').checked = faq.IsActive;
            document.getElementById('faqModal').classList.add('show');
        }

        // Close modal
        function closeModal() {
            document.getElementById('faqModal').classList.remove('show');
        }
        
        // Save FAQ
        function saveFAQ(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const id = document.getElementById('faqId').value;
            const isEdit = id !== '';

            const url = isEdit ? `/admin/faq/${id}` : '/admin/faq';
            const method = isEdit ? 'PUT' : 'POST';

            // Handle checkbox - convert to string "true" or "false"
            const isActiveCheckbox = document.getElementById('is_active');
            formData.delete('is_active');
            formData.append('is_active', isActiveCheckbox.checked ? 'true' : 'false');

            fetch(url, {
                method: method,
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    window.location.reload();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            });
        }
        
        // Delete FAQ
        function deleteFAQ(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸¸è§é—®é¢˜å—ï¼Ÿ')) {
                return;
            }
            
            fetch(`/admin/faq/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            });
        }
        
        // Drag and drop functionality
        let draggedItem = null;
        const faqList = document.getElementById('faqList');
        
        faqList.addEventListener('dragstart', function(e) {
            if (e.target.classList.contains('faq-item')) {
                draggedItem = e.target;
                e.target.classList.add('dragging');
            }
        });
        
        faqList.addEventListener('dragend', function(e) {
            if (e.target.classList.contains('faq-item')) {
                e.target.classList.remove('dragging');
                draggedItem = null;
            }
        });
        
        faqList.addEventListener('dragover', function(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(faqList, e.clientY);
            if (afterElement == null) {
                faqList.appendChild(draggedItem);
            } else {
                faqList.insertBefore(draggedItem, afterElement);
            }
        });
        
        faqList.addEventListener('drop', function(e) {
            e.preventDefault();
            updateSortOrders();
        });
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.faq-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // Update sort orders
        function updateSortOrders() {
            const items = document.querySelectorAll('.faq-item');
            const updates = [];
            
            items.forEach((item, index) => {
                const id = item.dataset.id;
                updates.push(
                    fetch(`/admin/faq/${id}/sort`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ sort_order: index * 10 })
                    })
                );
            });
            
            Promise.all(updates).then(() => {
                // Optionally show success message
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('faqModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>